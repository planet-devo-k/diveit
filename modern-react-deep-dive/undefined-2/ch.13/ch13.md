# Chapter 13

## 1. 애플리케이션에서 확인하기

### 1. create-react-app

```jsx
// reportWebVitals.ts
import { ReportHandler } from 'web-vitals'

const reportWebVitals = (onPerfEntry?: ReportHandler) => {
	if (onPerfEntry && onPerfEntry instanceof Function) {
		import('web-vitals'.then(({ getCLS, getFID, getFCP, getCLP, getTTFB }) => {
			getCLS(onPerfEntry)
			getFID(onPerfEntry)
			getFCP(onPerfEntry)
			getLCP(onPerfEntry)
			getTTFB(onPerfEntry)
		})
	}
}

export default reportWebVitals

// ...

reportWebVitals()
```

reportWebVitals 함수는 웹에서 성능을 측정하기 위한 함수. CLS, FID, FCP, LCP, TTFB를 측정하는 용도로 사용됨.

### 2. create-next-app

next.js에서도 create-react-app과 비슷한 방식으로 사용해 볼 수 있음. NextWebVitalMetric이라는 메서드를 제공.

기본적인 핵심 웹 지표 외에도 다음과 같은 Next.js에 특화된 사용자 지표를 제공

* Next.js-hydration : 페이지가 서버 사이드에서 렌더링되어 하이드레이션 하는데 걸린 시간
* Next.js-route-change-to-render : 페이지가 경로를 변경한 후 페이지를 렌더링을 시작하는데 걸리는 시간
* Next.js-render: 경로 변경이 완료된 후 페이지를 렌더링하는데 걸린 시간

## 2. 구글 라이트하우스

구글에서 제공하는 웹 페이지 성능 측정 도구. 오픈소스로 운영되고 있음. 핵심 웹 지표 뿐만 아니라 접근성, PWA, SEO 등 웹페이지를 둘러싼 다양한 요소들을 측정하고 점검할 수 있음.

* 브라우저 확장 프로그램 설치
  * 크롬
  * 파이어폭스
* 크롬 개발자 도구: 크롬의 개발자 도구에는 라이트하우스가 기본적으로 내장되어있음.
* CLI: lighthouse라는 npm 라이브러리를 이용하면 CLI 명령어로 지표를 수집할 수 있음.

크롬에 설치된 확장 프로그램 등이 영향을 줄 수 있으므로 가급적 시크릿 모드로 실행해 확인하는 것을 권장

### 1. 구글 라이트 하우스 - 탐색 모드

일반적으로 페이지에 접속했을 때부터 페이지 로딩이 완료될 때까지 성능을 측정하는 모드 . 이 모드로 측정을 시작하면 페이지를 처음부터 다시 불러와서 페이지 로딩이 끝날 때까지 각각의 지표를 수집

#### 성능

웹페이지의 성능과 관련된 지표를 확인할 수 있는 영역

FCP, LCP, CLS 외에도 3가지 추가적인 지표가 있음.

* Time to Interactive : 페이지에서 사용자가 완전히 상호작용 할 수 있을 때까지 걸리는 시간을 측정. 여기서 상호작용에 걸리는 시간 까지란 다음과 같은 것을 의미
  * 최초 콘텐츠풀 페인트로 측정되는 페이지 내 콘텐츠가 표시되는 시점
  * 보여지는 페이지 요소의 대부분에 이벤트 핸들러가 부착되는 시점
  * 페이지가 유저의 상호작용에 50ms 내로 응답하는 시점 구글에서는 이 지표가 3.8초 이내면 좋음 7.3 초 이내면 보통. 그 이후는 개선이 필요한 것으로 봄
* Speed Index: 페이지가 로드되는 동안 콘텐츠가 얼마나 빨리 시각적으로 표시되는 지를 계산. 구글에서는 이 지표가 3.4초 이내면 좋음 5.8초 이내면 보통 그 이후는 느리다고 판단
* Total Blocking Time: 메인스레드에서 특정 시간 이상 실행되는 작업, 즉 긴 작업이 수행될 때마다 메인 스레드가 차단된 것으로 간주. 사용자가 무언가 작업이 진행되고 있지 않다는 것을 눈치챌 수 있는 시간을 대상으로만 총 차단시간을 구하게 됨.

#### 접근성

장애인 및 고령자 등 신체적으로 불편한 사람들이 일반적인 사용자와 동등하게 웹페이지를 이용할 수 있도록 보장하는 것을 말함.

#### 권장사항

웹 사이트를 개발할 떄 고려해야 할 요소들을 얼마나 지키고 있는지 확인할 수 있음

* CSP가 XSS 공격에 얼마나 효과적인지 확인
* 감지된 JavaScript 라이브러리
* HTTPS 사용
* 페이지 로드 시 위치정보 권한 요청 방지하기
* 페이지 로드 시 알림 권한 요청 방지하기
* 알려진 보안 취약점이 있는 프론트엔드 자바스크립트 라이브러리를 사용하지 않음
* 사용자가 비밀번호 입력란에 붙여넣을 수 있도록 허용
* 이미지를 올바른 가로세로 비율로 표시
* 이미지가 적절한 해상도로 제공됨
* 페이지에 HTML Doctype 있음
* 문자 집합을 제대로 정의함
* 지원 중단 API
* 콘솔에 로그된 브라우저 오류 없음
* Chrome Devtools의 Issues 패널에 문제 없음
* 페이지에 유효한 소스 맵이 있음
* font-display: optional

#### 검색엔진 최적화

* 문서를 크롤링 하기 쉽게 만들었는지
* robots.txt가 유효한지
* 이미지와 링크에 설명 문자가 존재하는지
* 나등으로 페이지의 정보를 빠르게 확인할 수 있는지

### 2. 구글 라이트하우스 - 기간 모드

실제 웹페이지를 탐색하는 동안 지표를 측정하는 것

#### 흔적(view Trace)

웹 성능을 추적한 기간을 성능 탭에서 보여줌. 단순히 구글에서 제안하는 감사를 보여주는 정도를 넘어서, 상세하게 시간의 흐름에 따라 어떻게 웹페이지가 로딩됐는지를 보여줌.

#### 트리맵

페이지를 불러올 때 함꼐 로딩한 모든 리소스를 함께 모아서 볼 수 있는 곳. 웹페이지의 전체 자바스크립트 리소스 중 어떠ㄴ한 파일이 전체 데이터 로딩 중 어느정도를 차지했는지를 비율로 확인할 수 있으며, 실제 불러온 데이터의 크기를 확인할 수도 있음.

### 3. 구글 라이트하우스 - 스냅샷

탐색모드와 매우 유사하지만 현재 페이지 상태를 기준으로 분석한다는 점이 다름.

## 3. WebPageTest

웹사이트 성능을 분석하는 도구로 가장 널리 알려진 도구.

* Site Performance: 웹사이트의 성능 분석을 위한 도구
* Core Web Vitals: 웹사이트의 핵심 웹 지표를 확인하기 위한 도구
* Lighthouse: 구글 라이트하우스 도구
* Visual Comparison: 2개 이상의 사이트를 동시에 실행해 시간의 흐름에 따른 로딩 과정을 비교하는 도구
* Traceroute: 네트워크 경로를 확인하는 도구

Core Web Vitals, Lighthouse는 크롬 개발자 도구로 갈음이 가능하며, Visual Comparison은 성격이 비슷하나 사이트끼리 비교하는 용도로 사용됨.

기본적으로 WebPageTest는 미국, 인도, 캐나다, 독일 등 한국과 어느 정도 거리가 먼 서버를 기준으로 테스트 하기 때문에 크롬 개발자 도구보다 성능 지표가 좋지 않을 가능성이 매우 높음.

### 1. Performance Summary

테스트가 완료되면 전체적인 결과를 요약해서 볼 수 있음

* Oppertunities & Experiments: 웹사이트에 대한 평가를 총 3가지로 나눠서 보여준다. 각 항목에 대한 평가를 내리며, 자세한 내용은 클릭을 통해 확인할 수 있음
  * Is it Quick: 웹사이트가 충분히 빠른지를 평가
  * Is it Usable: 웹사이트의 사용성과 시각적인 요소를 확인.
  * Is is Resilient: 보안 취약성을 점검
* Observed Metrics: 최초 바이트까지의 시간, 렌더링 시작에 소요되는 시간, 최초 콘텐츠풀 페인트 등 측정할 수 있는 다양한 시간 지표에 대해 나타냄.
  * 주황색 실선: 웹사이트의 모습이 변경된 경우
  * 주황색 점선: 웹사이트의 모습이 변경됐고, 레이아웃 이동도 일어난 경우
  * 빨간색 실선: 최대 콘텐츠풀 페인트
  * 빨간색 점선: 최대 콘텐츠풀 페인트와 동시에 레이아웃 이동도 일어난 경우
* Indivisual Runs: 기본적으로 WebPageTest는 3번의 테스트를 돌려 평균값을 보여주는데, 각 실행별로 어떠한 결과를 보여주는지 확인할 수 있음.

### 2. Oppertunities & Experiments

* 최초 바이트까지의 시간(TTFB)을 점검
* 렌더링을 블로킹하는 자바스크립트가 있는지 확인한다
* 렌더링을 블로킹하는 CSS가 있는지 확인
* 최초 콘텐츠풀 페인트가 2.5초 이내인지 확인
* 주요 영역 내에 게으른 이미지가 있는지 확인
* 주요 영역 외에 이미지가 게으르게 로딩되는지 확인
* 문자의 노출을 지연시키는 커스텀 폰트가 있는지 확인
* 제 3자 호스트에게서 폰트를 불러오는 지 확인
* 실제로 사용하지 않는 리소스를 rel=preload로 불러오지 않는지 확인
* HTTP 리다이렉트되는 리소스가 없어야함 ⇒ 리다이렉트는 추가적인 네트워크 요청을 유발하기 때무
* 최초로 다운로드 받으 HTML과 최종 결과물 HTML 사이에 크기 차이가 적어야 함
* Is it Usable
  * 이미지 비율 부재로 인한 레이아웃 이동 가능성 여부를 확인
  * 어떤 이유에서건 메인 스레드가 장시간 멈춰있어서는 안됨
  * meta: viewport가 적절하게 삽입돼 있어야 함.
* Is it Resilient
  * 렌더링을 막는 제3자 라이브러리 요청이 없어야 함
  * Snyk에서 검출된 보안 위협이 없어야함
  * 모든 요청은 HTTP가 아닌 HTTPS를 거쳐야 함
  * 최초로 다운로드한 HTML과 최종 결과물 HTML 사이에 크기 차이가 적어야 함

### 3. Filmstrip

웹사이트를 마치 필름을 보는 것처럼 시간의 흐름에 따라 어떻게 웹사이트가 그려졌는지, 또 이떄 어떤 리소스가 불러와졌는지 볼 수 있는 메뉴.

### 4. Details

Filmstrip에서 보여준 내용을 자세하게 보여주는 영역.

### 5. Web Vitals

최대 콘텐츠풀 페인트, 누적 레이아웃 이동, 총 블로킹 시간에 대한 자세한 내용을 확인할 수 있음.

### 6. Optimizations

최적화와 관련된 메뉴

* Keep-Alive 설정으로 서버와의 연결을 계속 유지하고 있는지
* Gzip으로 리소스를 압축하고 있는지
* 이미지를 적절하게 압축했는지
* Progressive JPEG으로 JPEG 이미지를 렌더링하고 있는지
* 리소스 캐시 정책이 올바르게 수립돼 있는지
* 리소스가 CDN을 거치고 있는지

### 7. Content

웹사이트에서 제공하는 콘텐츠, 에셋을 종류별로 묶어 통계를 보여줌

### 8. Domains

Content메뉴에서 보여준 에셋들이 어느 도메인에서 왔는지를 도메인별로 묶어서 확인할 수 있음. 그리고 해당 도메인별로 요청한 크기는 어느 정도인지도 확인할 수 있음

### 9. Console.log

사용자가 웹페이지에 접속했을 때 Console.log로 무엇이 기록됐는지 확인할 수 있음. 대부분의 경우 사용자가 확인할 수 없으며 console.log 자체도 부하가 발생하는 작업이므로 가급적 console.log를 기록하는 일은 없어야 함.

### 10. Detected Technologies

웹사이트를 개발하는 데 사용된 기술을 확인할 수 있는 메뉴

### 11. Main-thread Processing

이 메뉴의 하위 항목인 Processing Breakdown에서는 메인 스레드가 어떤 작업을 처리했는지 확인할 수 있음. 여기서 리소스를 기다리는 idle time(유휴시간)은 포함되지 않음. 메인 스레드의 작업을 크게 스크립트 실행(Scripting), 레이아웃(Layout), 리소스 로딩(Loading), 페인팅(Painting), 기타의 총 다섯가지로 분류해서 알려줌

### 12. Lighthouse Report

구글 라이트 하우스 리포트를 확인할 수 있다. 크롬 개발자 도구에서 확인할 수 있는 라이트하우스와 다르게 개발자의 브라우저가 아닌 원격지의 다소 일반적인 모바일 기기의 브라우저에서 측정됨

### 13. 기타

* Image Analysis: Cloudinary로 연결되며, 해당 웹사이트에 어떠한 이미지가 있는지, 그리고 이 이미지들이 최적화 된다면 리소스를 어느정도 아낄 수 있는 지 보여줌
* Request Map: 웹사이트에서 요청이 어떻게 일어나고 있는지를 시각화 도구로 보여줌
* Data Cost : 각 국가별로 가장 저렴한 요금제를 기준으로 이 웹사이트를 로딩했을 때 실제로 가격이 얼마나 드는지 확인할 수 있음
* Security Score: 유명한 보안업체인 Snyk에서 제공하는 기능. 해당 사이트의 보안 취약점에 대해 알려줌

## 4. 크롬 개발자 도구

### 1. 성능 통계

라이트하우스와 비슷하게 Page Load를 선택해 웹사이트 로딩 시작부터 끝까지를 확인하거나, 혹은 Start Recording을 눌러 원하는 액션을 수행하면서 우베사이트 성능을 측정할 수 있음.

고의로 네트워크와 CPU 속도를 지연시키는 기능도 있음. 속도를 고의로 지연시켜 개발자의 최신 디바이스 성능이 아닌 일반적인 모바일 사용자의 상대적으로 열악한 환경을 재현할 수 있다.

#### insights

성능을 측정하는 기간동안 발생한 이벤트 중 눈여겨봐야할 내용을 시간의 흐름에 따라 모여서 보여줌

* 핵심 웹 지표
* Performance Measure: User Timing API로 측정한 지표들을 확인할 수 있음
* Long Task: 메인스레드에서 실행되는데 오랜 시간으로 분류된 긴 작업을 의미
* Render blocking CSS
* Forced Style recalculation

#### 메인 메뉴

성능을 측정하는 기간동안 무슨 일이 일어나는지 확인할 수 있는 다양한 기능을 제공

### 2. 성능

Performance Insights 탭이 있기 이전부터 있었던 탭으로, 성능 분석에 사용하기 위해 만들어진 탭. Performance Insights 탭에 비해 다소 내용이 어렵고 복잡하지만 그만큼 더 자세한 정보를 조금 더 세밀하게 확인해 볼 수 있다는 장점이 있음.

#### 메뉴

#### 요약

측정 기간의 CPU, 네트워크 요청, 스크린숏, 메모리 점유율 등을 요약해서 볼 수 있음.

#### 네트워크

성능 측정 기간 동안 발생한 모든 네트워크 요청을 확인할 수 있음

* 파란색 : HTML
* 보라색: CSS
* 노란색: 자바스크립트
* 초록색: 이미지
* 회색: 기타
* 폰트
* JSON 등

읽는방법

* 왼쪽 선은 연결을 시작되기 위한 기간을 나타냄
* 대표 색상의 막대 그래프 중 색이 더 연한 왼쪽은 요청을 보내고 최초 바이트가 오기까지의 대기 시간을 의미
* 대표 색상의 막대 그래프 중 색이 진한 오른쪽은 콘텐츠를 다운로드하는데 걸리는 시간을 의미
* 마지막에 거의 안보이는 오른쪽 선은 메인 스레드의 응답을 기다리는 시간인데, 이는 네트워크의 소요 시간에 포함하지 않음.

#### Web Vitals

핵심 웹 지표 시점을 확인할 수 있는 영역

#### 소요 시간과 기본

시간의 흐름에 따라 메인 스레드의 작업은 어떻게 이뤄졌는지, 또 자바스크립트 힙 영역은 어떻게 변화하는지 확인할 수 있음.
