# Chapter 7

## 1. 크롬 개발자 도구란?

크롬에서 제공하는 개발자용 도구. 제대로 디버깅하고 싶다면 시크릿모드에서 페이지와 개발자 도구를 여는 것을 권장.

## 2. 요소 탭

현재 웹 페이지를 구성하는 HTML, CSS 등의 정보를 확인할 수 있다.

### 1. 요소 화면

단순히 현재 HTML을 보는 것만 아닌 직접 코드를 수정해서 웹 페이지에서 어떻게 보이는지 빠르게 확인이 가능. 중단점을 사용해 디버깅도 가능하며, 요소에 속성을 추가, 수정, 삭제하거나 해당 요소를 스크린 샷으로 캡처하거나 숨기는 등 DOM과 관련된 다양한 작업이 가능

### 2. 요소 정보

* 스타일: 요소와 관련된 스타일 정보를 나타냄. 이 내용도 수정해서 어떻게 페이지에 반영되는지 미리 확인 가능
* 계산됨: 요소의 크기, 패딩, 보더, 마진과 각종 CSS 적용 결괏값을 알 수 있는 탭
* 레이아웃: CSS 그리드나 레이아웃과 관련된 정보를 확인할 수 있음.
* 이벤트 리스너: 현재 요소에 부착된 각종 이벤트 리스너를 확인할 수 있음. 이벤트 버블링 등으로 발생시키는 경우 이벤트 위임의 변경에서 확인가능
* DOM 중단점: 중단점이 있는지 알려주는 탭
* 속성: 해당 요소가 가지고 있는 모든 속성값.
* 접근성: 웹이용에 어려움을 겪는 장애인, 노약자를 위한 스크린 리더기 등이 활용하는 값

## 3. 소스 탭

웹 애플리케이션을 불러오기 위해 실행하거나 참조된 모든 파일을 확인할 수 있음.

* 장점 소스 중단점을 생성해 자바스크립트 실행을 중단시키고 디버깅을 수행시킬 수 있음. 코드에 debugger를 선언하는것과 동일한 역할을 하지만 이 방법은 소스코드를 오염시키지 않을 수 있음.
* 소스탭 오른쪽에서 제공하는 정보와 기능
  * 감시: 감시하고 싶은 변수를 선언하고 해당 변수의 정보를 확인할 수 있는 메뉴
  * 중단점: 현재 웹사이트에서 추가한 중단점을 확인할 수 있음
  * 범위: 현재 중단점에서의 스코프
  * 호출 스택: 현재 중단점의 콜스택 확인 가능
  * 전역 리스너: 현재 전역 스코프에 추가된 리스너 목록 확인 가능
  * XHR/가져오기, DOM, 이벤트 리스너, CSP 위반 중단점: 소스의 중단점이외에 다양한 중단점 확인 가능

## 4. 네트워크 탭

해당 웹페이지를 접속하는 순간부터 발생하는 모든 네트워크 관련 작동이 기록. 웹사이트에서 자주 사용하는 HTTP 요청부터 웹 소켓에 이르기까지 웹페이지가 외부 데이터와 통신하는 정보를 확인할 수 있음.

상단에는 네트워크 요청 종류를 필터링 할 수 있으며, 왼쪽에는 실제 해당 페이지를 불러오는 과정에서 발생한 네트워크 요청을 볼 수 있다. 하단에는 페이지를 불러오는 기간동안 발생한 총 요청 건수와 총 다운로드한 업로드 리소스의 크기를 확인할 수도 있다. 마지막으로 스크릿샷 캡처 기능을 활용하면 네트워크 요청 흐름에 따라 웹페이지가 어떻게 로딩되고 있는지 확인할 수 있음

## 5. 메모리 탭

리액트 개발 도구의 프로파일과 비슷하게 프로파일링 작업을 거쳐야 원하는 정보를 볼 수 있음.

* 힙 스냅샷: 현재 메모리 상황을 스냅샷 찍듯이 촬영할 수 있다.
* 타임라인의 할당 계측: 시간의 흐름에 따라 메모리의 변화를 살펴보고 싶을 때 사용
* 할당 샘플링: 메모리 공간을 차지하고 있는 자바스크립트 함수를 볼 수 있음

### 1. 자바스크립트 인스턴스 VM 선택

개발자가 디버깅하고 싶은 자바스크립트 VM 환경을 선택할 수 있음.

### 2. 힙 스냅샷

현재 페이지의 메모리 상태를 확인해 볼 수 있는 메모리 프로파일 도구.

스냅샷 촬영을 제대로 활용하려면 하나의 스냅삿을 가지고 파악하는 것보다 스냅샷을 두 개 이상을 촬영한 다음, 그 차이를 비교하는 것이 훨씬 수월함. 또 어떤 탭이든 디버깅을 빠르고 원활하게 하려면 기명함수를 사용하는 편이 좋음.

### 3. 타임라인 할당 계측

시간의 흐름에 따라 메모리 변화를 확인할 수 있는 기능

### 4. 할당 샘플링

시간의 흐름에 따라 발생하는 메모리 점유를 확인할 수 있다는 점에서 타임라인 할당 계측과 비슷하지만, 자바스크립트 실행 스택별로 분석할 수 있고, 이 분석을 함수 단위로 한다는 차이점이 있음.

## 6. Next.js 환경 디버깅

### 1. Next.js 프로젝트를 디버그 모드로 실행하기

```jsx
"dev": NODE_OPTIONS='--inspect' next dev
```

해당 명령어 실행 후 웹소켓 주소가 나타나면 디버거에 연결된 준비가 된것. 그다음 크롬 브라우저에서 chrome://inspect로 이동해서 Open dedicated DevTools for Node 를 클릭하면 새로운 창에서 개발자 도구가 나타남.

### 2. Next.js 서버에 트래픽 유입시키기

아파치 재단에서 제공하는 오픈 소스 도구인 ab를 활용하여 HTTP 서버의 성능을 벤치마킹할 수 있음.

```jsx
>> ab -k -c 50 -n 10000 "http://127.0.0.1:3000"
```

이 명령어는 http://127.0.0.1:3000을 향해 한번에 50개의 요청을 총 10000회 시도함. 로컬에서 테스트할 경우 주소를 localhost로 하면 정상적으로 실행되지 않으므로 반드시 IP나 올바른 주소를 기재해야 한다.

ab를 사용하면 요청으로부터 응답받는데 걸린시간, 바이트 크기 등 다양한 정보를 확인할 수 있음.

### 3. Next.js의 메모리 누수 지점 확인하기

```jsx
import type { GetServerSidePropsContext, NextPage } from 'next'

const access_users = []

function Home({ currentDateTime }: { currentDateTime: number}) {
	return <>{currentDateTime}</>
}

export const getServerSideProps = (ctx: GetServerSidePropsContext) => {
	const currentDateTime = new Date().getTime()

	access_users.push({
		user: `user-${Math.round(Math.random() * 100000}`,
		currentDateTime,
	})

	return {
		props: {
			currentDateTime,
			},
		}
	}

export default Home
```

해당 코드를 브라우저에서 next 애플리케이션을 방문한뒤 다시 메모리 탭에서 변화를 살펴보면 getServerSideProps의 다수 실행과 메모리 누수를 확인할 수 있음. getServerSideProps는 페이지 접근 요청이 있을 떄마다 실행되는 함수이므로 최대한 부수 효과가 없는 순수함수로 만들어야 함. 만약 이 함수 내부에서 외부 스코프의 변수에 의존하는 작업을 한다면 지금과 같은 메모리 누수 상황을 마주할 수도 있음.
