# 서버 및 Supabase 세팅

[출처 참고](https://github.com/winterlood/onebite-books-server)

## Supabase(또는 PostgreSQL)의 연결 방식 세 가지

- 데이터베이스 연결을 어떻게 관리하고 유지하느냐에 따라 구분됩니다.
- 개발 중인 서비스의 환경(서버리스 여부, 동시 접속자 수 등)에 맞춰 선택하는 것이 중요합니다.
- supabase 무료 요금제는 1주일 동안 어떤 API도 요청하지 않으면 자동으로 pause상태가 되서 어떤 api도 요청할수 없게됨
  - dashboard > project > restore project 버튼 > 복구. 빠르면 10분 늦으면 2시간 정도 걸린다. API연결도 복구되는데 좀 시간 걸릴수 있다.
  - 시간을 단축하려면 새로운 프로젝트 생성해서 다시 connection string 연결

1. zip 코드 다운
2. supabase회원가입, project 생성
3. connection string 연결 (.env)

- database pw 잊어버리면 reset 해 재설정 후 env 에 붙여넣기

4. 서버폴더 → pnpm i
5. `npx prisma db push` supabase db 초기화 (준비된 table 넣기)
6. `pnpm run seed` table에 초기 데이터 넣기
7. `pnpm run build` 백엔드 서버 빌드
8. `pnpm run start` 백엔드 서버 실행 localhost:12345 로 접속 가능
9. `npx prisma studio` 데이터베이스를 실시간 조회할 수 있는 페이지로 접속 localhost:5555

- 데이터를 어떻게 보관했는지 궁금하면 이렇게 확인
- [API 문서](http://localhost:12345/api)는 서버가 가동중일때만 동작

![connection method](./assets/supabase-setting1.png)

- Direct Connection (직접 연결)
  - 데이터베이스 서버에 직접 통로를 만드는 방식입니다.
  - 동작 방식: 애플리케이션이 켜질 때 DB와 연결을 맺고, 종료될 때까지 그 연결을 계속 유지합니다.
  - 특징: 매번 연결을 맺는 비용이 들지 않아 빠르지만, DB가 수용할 수 있는 최대 연결 수(Connection Limit)가 정해져 있어 접속자가 많아지면 서버가 버티기 힘듭니다.
  - 추천 상황: 24시간 계속 돌아가는 백엔드 서버(EC2, Docker 컨테이너 등)나 마이그레이션 작업을 수행할 때 적합합니다.

- Transaction Pooler - 권장
  - 중간에 PgBouncer 같은 '중개자'를 두는 방식입니다.
  - 동작 방식: 실제 DB 연결은 풀러가 쥐고 있다가, 애플리케이션에서 쿼리(트랜잭션)를 보낼 때만 잠깐 연결을 빌려주고 작업이 끝나면 즉시 회수합니다.
  - 특징: 하나의 DB 연결을 여러 사용자가 번갈아가며 효율적으로 나눠 쓸 수 있어, 수천 개의 동시 연결도 처리 가능합니다.
  - 추천 상황: Vercel, AWS Lambda 같은 서버리스(Serverless) 환경이나 프론트엔드 프레임워크(Next.js 등)를 사용할 때 필수적입니다.

- Session Pooler
  - 직접 연결과 트랜잭션 풀러의 중간 형태입니다.
  - 동작 방식: 특정 사용자가 접속해 있는 동안(세션 유지 기간) 연결을 계속 할당해 줍니다.
  - 특징: 트랜잭션 풀러보다 연결을 점유하는 시간이 길기 때문에 효율성은 낮지만, 특정 DB 설정이 세션 단위로 유지되어야 할 때 사용합니다.
  - 추천 상황: IPv4 네트워크 제약이 있는 환경에서 직접 연결의 대안으로 주로 사용됩니다. 일반적인 웹 서비스 개발에서는 트랜잭션 풀러보다 덜 선호됩니다.
    - IPv4(Internet Protocol version 4): 전 세계 컴퓨터들이 서로를 식별하고 통신하기 위해 사용하는 주소 체계
      - IPv4 주소는 32비트(bit)로 구성되어 있으며, 우리가 보기 편하도록 8비트씩 4부분으로 나누어 점(.)으로 구분합니다.
      - 형태: 192.168.0.1
      - 숫자 범위: 각 마디는 0부터 255까지의 숫자로 이루어집니다.
      - 총 개수: 약 43억 개 ($2^{32}$) 정도의 주소를 만들 수 있습니다.
    - 인터넷이 처음 생길 때는 43억 개의 주소가 충분할 것으로 생각했지만, 스마트폰, IoT 기기 등이 폭발적으로 늘어나면서 IPv4 주소는 이미 고갈되었습니다. 이를 해결하기 위해 두 가지 기술이 주로 쓰입니다.
      - NAT (공유기 원리): 하나의 공인 IP를 여러 기기가 나누어 쓰는 방식입니다.
      - IPv6: 주소 길이를 128비트로 대폭 늘린 차기 버전입니다. 거의 무한대에 가까운 주소를 제공합니다.
